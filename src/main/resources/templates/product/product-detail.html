<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<style>
    .post-title {
        font-size: 36px;
        font-weight: bold;
        color: #222;
        font-family: 'Roboto', sans-serif;
        letter-spacing: 1px;
        margin-bottom: 14px;
    }
    .post-subtitle {
        font-size: 18px;
        font-weight: 400;
        color: #666;
        font-family: 'Roboto', sans-serif;
        letter-spacing: 0.5px;
        margin-bottom: 15px;
        line-height: 1.5;
        text-align: justify;
    }
    .price {
        font-size: 22px;
        font-weight: 700;
        color: #e74c3c;
        font-family: 'Roboto', sans-serif;
        margin-top: 10px;
        display: block;
    }
</style>

<!-- 헤더 -->
<th:block th:replace="~{layout/fragments/header :: headerFragment}"></th:block>

<div class="container mt-5">
    <div class="row">
        <!-- 제품 이미지 -->
        <div class="col-md-6 text-center">
            <img th:src="@{'/uploadfile/' + ${productDTO.imageUrl}}"
                 class="img-fluid rounded shadow-lg"
                 alt="상품 이미지"
                 style="width: 450px; height: auto; object-fit: cover;"
                 onerror="this.src='/uploadfile/default-image.png';">
        </div>

        <!-- 제품 정보 -->
        <div class="col-md-6">
            <h1 class="post-title" th:text="${productDTO.title}">상품 제목</h1>
            <p class="post-subtitle" th:text="${productDTO.content}">상품 설명</p>
            <!-- 가격 -->
            <p class="price"><span id="price" th:text="${productDTO.price}"></span> 원</p>
            <script>
                const priceElement = document.getElementById("price");
                const price = parseInt(priceElement.textContent);
                priceElement.textContent = price.toLocaleString();
            </script>

            <ul class="list-unstyled mt-4">
                <li><strong>카테고리:</strong> <span th:text="${productDTO.category}"></span></li>
                <li><strong>작성자:</strong> <span th:text="${productDTO.getUserId()}"></span></li>
                <li><strong>등록일:</strong> <span th:text="${formattedCreateDate}"></span></li>
                <div th:if="${formattedUpdateDate != null}">
                    <li><strong>수정일:</strong> <span th:text="${formattedUpdateDate}"></span></li>
                </div>
                <li><strong>상품 상태:</strong> <span th:text="${productDTO.productCondition}"></span></li>
                <li><strong>거래희망 시간:</strong> <span th:text="${formattedDealDate}"></span></li>
                <li><strong>위치:</strong> <span th:text="${productDTO.location}"></span></li>
            </ul>

            <!-- 버튼 -->
            <div class="mt-5">
                <a href="/products" class="btn btn-outline-secondary btn-lg">목록으로 돌아가기</a>
                <button type="button" class="btn btn-info" onclick="bookmark()">찜하기</button>

                <script th:inline="javascript">
                    function bookmark() {
                        // LikeList 객체 생성 (상품 ID와 사용자 ID)
                        const likeList = {
                            product: {
                                id: [[${productDTO.itemCode}]]
                            },
                            member: {
                                id: [[${member.id}]]
                            }
                        };

                        fetch('/likeList', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(likeList),
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data) {
                                    alert('찜 목록에 추가되었습니다.');
                                } else {
                                    alert('찜 목록 추가에 실패했습니다.');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('오류가 발생했습니다.');
                            });
                    }
                </script>


                <!-- 로그인한 사용자일 경우 삭제/수정 버튼 -->
                <div th:if="${productDTO.userId == member.id}" class="d-inline-block ml-3">
                    <button type="button" id="deleteBtn" class="btn btn-danger">삭제</button>
                    <button type="button" id="updateBtn" class="btn btn-warning">수정</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 댓글 목록 출력 -->
<div class="container mt-5">
    <h2>댓글</h2>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- 댓글이 없을 때 메시지 표시 -->
            <div th:if="${#lists.isEmpty(comments)}">
                <p>댓글이 없습니다.</p>
            </div>

            <!-- 댓글 목록 출력 -->
            <div th:each="comment : ${comments}" class="comment-card card mt-4">
                <div class="card-body">
                    <h5 class="comment-author" th:text="${comment.userId}">작성자</h5>
                    <p class="comment-text" th:text="${comment.content}">댓글 내용</p>
                    <p class="comment-date" th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}">
                        작성일자</p>


                    <div th:if="${comment.userId == userid}">
                        <form action="/api/comments/delete" method="post" style="display:inline;">
                            <input type="hidden" name="commentId" th:value="${comment.commentId}">
                            <input type="hidden" name="itemCode" th:value="${productDTO.itemCode}">
                            <input type="hidden" name="_csrf" value="${_csrf.token}"> <!-- CSRF 토큰 추가 -->
                            <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 댓글 작성 폼 -->
<div class="container mt-5" th:if="${userid != ''}">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h3>댓글 작성</h3>
            <form id="commentForm">
                <input type="hidden" name="itemCode" id="itemCode" th:value="${productDTO.itemCode}">
                <div class="form-group">
                    <label for="content">댓글 내용</label>
                    <textarea id="content" name="content" class="form-control" rows="3" placeholder="댓글을 입력하세요..."
                              required></textarea>
                </div>
                <input type="hidden" name="userId" id="userId" th:value="${userid}">
                <button type="submit" class="btn btn-primary btn-block">댓글 작성</button>
            </form>
        </div>
    </div>
</div>

<!-- 비회원일 경우 로그인 안내 메시지 -->
<div class="container mt-5" th:if="${userid == ''}">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <p>댓글을 작성하려면 <a th:href="@{/member/login}">로그인</a> 해주세요.</p>
        </div>
    </div>
</div>

<!-- CSRF 토큰 메타 태그 추가 -->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<script>
    const currentUserId = "[[${userid}]]";

    document.getElementById("commentForm").addEventListener("submit", function (event) {
        event.preventDefault();  // 폼의 기본 제출 동작을 막음

        const content = document.getElementById("content").value;
        const itemCode = document.getElementById("itemCode").value;

        // CSRF 토큰 설정
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        // AJAX 요청
        fetch("/api/comments", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken  // CSRF 토큰 추가
            },
            body: JSON.stringify({
                content: content,
                itemCode: itemCode
                // userId는 세션에서 자동으로 가져옴
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addCommentToList(data.comment);  // 새로운 댓글을 목록에 추가
                    document.getElementById("content").value = "";  // 폼 초기화
                } else {
                    alert("댓글 작성에 실패했습니다.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
    });

    function addCommentToList(comment) {
        const noCommentsMessage = document.querySelector(".col-md-8 p");
        if (noCommentsMessage && noCommentsMessage.textContent === '댓글이 없습니다.') {
            noCommentsMessage.remove();
        }

        const commentSection = document.querySelector(".col-md-8");

        const newComment = document.createElement("div");
        newComment.classList.add("comment-card", "card", "mt-4");

        newComment.innerHTML = `
            <div class="card-body">
                <h5 class="comment-author">${comment.userId}</h5>
                <p class="comment-text">${comment.content}</p>
                <p class="comment-date">${new Date(comment.createDate).toLocaleString()}</p>
                ${comment.userId === currentUserId ? `
                    <form action="/api/comments/delete" method="post" style="display:inline;">
                        <input type="hidden" name="commentId" value="${comment.commentId}">
                        <input type="hidden" name="itemCode" value="${comment.itemCode}">
                        <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                    </form>
                ` : ''}
            </div>
        `;
        commentSection.appendChild(newComment);
    }

    // 삭제 버튼 클릭 시 확인 후 삭제 처리
    document.getElementById('deleteBtn').addEventListener('click', function () {
        if (confirm("상품을 삭제하시겠습니까?")) {
            const itemCode = document.querySelector('input[name="itemCode"]').value;

            fetch(`/api/products/${itemCode}`, {
                method: "DELETE"
            })
                .then(response => {
                    if (response.ok) {
                        alert("상품이 삭제되었습니다.");
                        window.location.href = "/products"; // 삭제 후 목록 페이지로 이동
                    } else {
                        alert("삭제에 실패했습니다.");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("오류가 발생했습니다.");
                });
        }
    });

    // 수정 버튼 클릭 시 해당 상품 수정 페이지로 이동
    document.getElementById('updateBtn').addEventListener('click', function () {
        const itemCode = document.querySelector('input[name="itemCode"]').value;
        window.location.href = `/products/update/${itemCode}`;
    });

    document.addEventListener('submit', function (event) {
        if (event.target.matches('form[action="/api/comments/delete"]')) {
            if (!confirm("댓글을 지우시겠습니까?")) {
                event.preventDefault();  // 취소 버튼을 누르면 폼 제출을 막음
            }
        }
    });

</script>

<th:block th:replace="~{layout/fragments/footer :: footerFragment}"></th:block>

</html>