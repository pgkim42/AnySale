<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{layout/fragments/header :: headerFragment}"></th:block>

<div class="container mt-5">
    <h1 class="text-center">상품 상세 정보</h1>
    <div class="row">
        <div class="col-md-6">
            <img th:src="@{${productDTO.imageUrl}}" class="img-fluid" alt="Product Image">
        </div>
        <div class="col-md-6">
            <h1 th:text="${productDTO.title}">상품 제목</h1>
            <h3 th:text="${productDTO.content}">상품 설명</h3>
            <p><strong>가격: </strong><span th:text="${productDTO.price}"></span></p>
            <p><strong>카테고리: </strong><span th:text="${productDTO.category}"></span></p>
            <p><strong>상품 상태: </strong><span th:text="${productDTO.productCondition}"></span></p>
            <p><strong>거래 날짜: </strong><span th:text="${productDTO.dealDate}"></span></p>
            <p><strong>상태: </strong><span th:text="${productDTO.status}"></span></p>
            <p><strong>위치: </strong><span th:text="${productDTO.location}"></span></p>
            <p><strong>판매자: </strong><span th:text="${productDTO.userId}"></span></p>
            <a href="/products" class="btn btn-primary">목록으로 돌아가기</a>
            <br>
            <div th:if="${productDTO.userId == member.id}">
                <form id="deleteProductForm" style="display:inline;">
                    <input type="hidden" name="itemCode" th:value="${productDTO.itemCode}">
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">삭제</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 댓글 목록 출력 -->
<div class="container mt-5">
    <h2>댓글</h2>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- 댓글이 없을 때 메시지 표시 -->
            <div th:if="${#lists.isEmpty(comments)}">
                <p>댓글이 없습니다.</p>
            </div>

            <!-- 댓글 목록 출력 -->
            <div th:each="comment : ${comments}" class="comment-card card mt-4">
                <div class="card-body">
                    <h5 class="comment-author" th:text="${comment.userId}">작성자</h5>
                    <p class="comment-text" th:text="${comment.content}">댓글 내용</p>
                    <p class="comment-date" th:text="${comment.createDate}">작성일자</p>

                    <!-- 댓글을 작성한 작성자일 경우에만 삭제 버튼 표시 -->
                    <div th:if="${comment.userId == userid}">
                        <form action="/api/comments/delete" method="post" style="display:inline;" onsubmit="return confirm('댓글을 지우시겠습니까?');">
                            <input type="hidden" name="commentId" th:value="${comment.commentId}">
                            <input type="hidden" name="itemCode" th:value="${productDTO.itemCode}">
                            <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 댓글 작성 폼 -->
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h3>댓글 작성</h3>
            <form id="commentForm">
                <input type="hidden" name="itemCode" id="itemCode" th:value="${productDTO.itemCode}">


                <div class="form-group">
                    <label for="content">댓글 내용</label>
                    <textarea id="content" name="content" class="form-control" rows="3" placeholder="댓글을 입력하세요..."
                              required></textarea>
                </div>
                <input type="hidden" name="userId" id="userId" th:value="${userid}">
                <button type="submit" class="btn btn-primary btn-block">댓글 작성</button>
            </form>
        </div>
    </div>
</div>

<script>

    const currentUserId = "[[${userid}]]";

    document.getElementById("commentForm").addEventListener("submit", function (event) {
        event.preventDefault();  // 폼의 기본 제출 동작을 막음

        const content = document.getElementById("content").value;
        const itemCode = document.getElementById("itemCode").value;
        const userId = document.getElementById("userId").value;

        // AJAX 요청
        fetch("/api/comments", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                content: content,
                itemCode: itemCode,
                userId: userId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 댓글 목록에 새로운 댓글을 추가
                    addCommentToList(data.comment);
                    // 폼 초기화
                    document.getElementById("content").value = "";
                } else {
                    alert("댓글 작성에 실패했습니다.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
    });

    // 새로운 댓글을 목록에 추가하는 함수
    function addCommentToList(comment) {
        // "댓글이 없습니다" 메시지가 있으면 삭제
        const noCommentsMessage = document.querySelector(".col-md-8 p");
        if (noCommentsMessage && noCommentsMessage.textContent === '댓글이 없습니다.') {
            noCommentsMessage.remove();
        }

        const commentSection = document.querySelector(".col-md-8");  // 댓글을 추가할 섹션

        const newComment = document.createElement("div");
        newComment.classList.add("comment-card", "card", "mt-4");

        newComment.innerHTML = `
         <div class="card-body">
            <h5 class="comment-author">${comment.userId}</h5>
            <p class="comment-text">${comment.content}</p>
            <p class="comment-date">${new Date(comment.createDate).toLocaleString()}</p>
            ${comment.userId === currentUserId ? `
                <form action="/api/comments/delete" method="post" style="display:inline;">
                    <input type="hidden" name="commentId" value="${comment.commentId}">
                    <input type="hidden" name="itemCode" value="${comment.itemCode}">
                    <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                </form>
            ` : ' '}
            </div>
        </div>
    `;

        commentSection.appendChild(newComment);
    }

    function confirmDelete() {
        if (confirm("상품을 삭제하시겠습니까?")) {
            const itemCode = document.querySelector('input[name="itemCode"]').value;

            fetch(`/api/products/${itemCode}`, {
                method: "DELETE"
            })
                .then(response => {
                    if (response.ok) {
                        alert("상품이 삭제되었습니다.");
                        window.location.href = "/products"; // 삭제 후 목록 페이지로 이동
                    } else {
                        alert("삭제에 실패했습니다.");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("오류가 발생했습니다.");
                });
        }
    }

</script>

<th:block th:replace="~{layout/fragments/footer :: footerFragment}"></th:block>

</html>
