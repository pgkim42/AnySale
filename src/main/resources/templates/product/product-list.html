<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Header Fragment 포함 -->
<th:block th:replace="~{layout/fragments/header :: headerFragment}"></th:block>

<!-- Header -->
<header class="bg-dark py-5">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
            <h1 class="display-4 fw-bolder">중고거래 매물</h1>
            <p class="lead fw-normal text-white-50 mb-0">지금 올라온 매물들을 둘러보세요.</p>
        </div>
    </div>
</header>

<!-- Section for Products -->
<section id="productSection" class="py-5">
    <div class="container px-4 px-lg-5 mt-5">
        <div id="productList" class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container mt-4">
        <ul class="pagination justify-content-center" id="pagination">

        </ul>
    </div>
</section>

<!-- Search form -->
<div class="container">
    <form th:action="@{/products/search}" method="get" class="mb-4">
        <div class="row justify-content-center">

            <div class="col-lg-3 col-md-4">
                <select class="form-select" name="searchType" id="searchType" onchange="toggleSearchInput()">
                    <option value="title" th:selected="${searchType == 'title'}">제목</option>
                    <option value="category" th:selected="${searchType == 'category'}">카테고리</option>
                </select>
            </div>

            <!-- 제목 검색 필드 -->
            <div class="col-md-5" id="keywordInput">
                <input type="text" class="form-control" name="titleKeyword" placeholder="검색어를 입력하세요"
                       th:value="${keyword}"/>
            </div>

            <!-- 카테고리 검색 드롭다운 -->
            <div class="col-md-5" id="categoryInput" style="display: none;">
                <select class="form-select" name="categoryKeyword">
                    <option value="의류" th:selected="${keyword == '의류'}">의류</option>
                    <option value="도서" th:selected="${keyword == '도서'}">도서</option>
                    <option value="전자제품" th:selected="${keyword == '전자제품'}">전자제품</option>
                </select>
            </div>

            <!-- Search Button -->
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">검색</button>
            </div>
        </div>
    </form>
</div>

<script type="text/javascript">
    // 페이지네이션 버튼 클릭 시 Ajax로 데이터 요청
    function loadProducts(page) {
        const searchType = document.getElementById('searchType').value;
        const keyword = document.querySelector('input[name="titleKeyword"]').value;

        fetch(`/products/searchAjax?searchType=${searchType}&keyword=${keyword}&page=${page}&size=20`)
            .then(response => response.json())
            .then(data => {
                updateProductList(data.content);
                updatePagination(data);          // 페이지네이션 업데이트
            })
            .catch(error => console.error('Error:', error));
    }

    // 제품 목록을 업데이트하는 함수
    function updateProductList(products) {
        const productList = document.getElementById('productList');
        productList.innerHTML = '';  // 기존 목록 제거

        products.forEach(product => {

            const formattedPrice = new Intl.NumberFormat('ko-KR').format(product.price) + ' 원';

            const productCard = `
            <div class="col mb-5">
                <div class="card h-100">
                    <img class="card-img-top p-1" src="/uploadfile/${product.imageUrl}" alt="상품이미지" onerror="this.src='/uploadfile/default-image.png';" />
                    <div class="card-body p-4">
                        <div class="text-center">
                            <h5 class="fw-bolder">${product.title}</h5>
                            <p class="text-muted mb-0">${product.category}</p>
                            <p>${product.content}</p>
                            <span>${formattedPrice}</span>
                        </div>
                    </div>
                    <div class="card-footer p-4 pt-0 border-top-0 bg-transparent">
                        <div class="text-center">
                            <a class="btn btn-outline-dark mt-auto" href="/products/detail/${product.itemCode}">자세히 보기</a>
                        </div>
                    </div>
                </div>
            </div>
        `;
            productList.insertAdjacentHTML('beforeend', productCard);  // 새 제품 카드 추가
        });
    }



    // 페이지네이션을 업데이트하는 함수
    function updatePagination(pageData) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';  // 기존 페이지네이션 제거

        // 이전 버튼
        if (pageData.number > 0) {
            pagination.insertAdjacentHTML('beforeend', `<li class="page-item"><a class="page-link" href="#" onclick="loadProducts(${pageData.number - 1}); return false;">Previous</a></li>`);
        }

        // 페이지 번호 버튼들
        for (let i = 0; i < pageData.totalPages; i++) {
            const activeClass = i === pageData.number ? 'active' : '';
            pagination.insertAdjacentHTML('beforeend', `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="loadProducts(${i}); return false;">${i + 1}</a></li>`);
        }

        // 다음 버튼
        if (pageData.number < pageData.totalPages - 1) {
            pagination.insertAdjacentHTML('beforeend', `<li class="page-item"><a class="page-link" href="#" onclick="loadProducts(${pageData.number + 1}); return false;">Next</a></li>`);
        }
    }

    // 검색 필드의 입력 타입을 토글하는 함수
    function toggleSearchInput() {
        let searchType = document.getElementById('searchType').value;
        let keywordInput = document.getElementById('keywordInput');
        let categoryInput = document.getElementById('categoryInput');

        if (searchType === 'category') {
            keywordInput.style.display = 'none';
            categoryInput.style.display = 'block';
        } else {
            keywordInput.style.display = 'block';
            categoryInput.style.display = 'none';
        }
    }

    // 페이지가 로드될 때 처음 목록을 가져옴
    document.addEventListener("DOMContentLoaded", function () {
        loadProducts(0);  // 첫 번째 페이지 로드
        toggleSearchInput();  // 페이지 로드 후 상태에 맞게 설정
    });

</script>

<!-- Footer Fragment 포함 -->
<th:block th:replace="~{layout/fragments/footer :: footerFragment}"></th:block>

</html>